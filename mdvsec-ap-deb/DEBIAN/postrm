#!/bin/bash
set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

case "$1" in
    purge)
        echo -e "${BLUE}MDVSEC: Purging configuration files...${NC}"

        # Remove systemd service files
        for service in mdvsec-client-monitor.service mdvsec-failover.service; do
            if [ -f "/etc/systemd/system/$service" ]; then
                rm -f "/etc/systemd/system/$service"
                echo "  Removed $service"
            fi
        done

        # Remove helper scripts
        for script in mdvsec-notify mdvsec-monitor-clients mdvsec-wan-failover.sh; do
            if [ -f "/usr/local/bin/$script" ]; then
                rm -f "/usr/local/bin/$script"
                echo "  Removed $script"
            fi
        done

        # Ask user if they want to remove configuration
        echo ""
        echo -e "${YELLOW}Configuration directory /etc/secure-ap contains your settings.${NC}"
        echo -e "${YELLOW}Remove it? (y/N)${NC}"
        read -r response
        if [ "$response" = "y" ] || [ "$response" = "Y" ]; then
            rm -rf /etc/secure-ap
            echo -e "${GREEN}Configuration removed.${NC}"
        else
            echo -e "${BLUE}Configuration preserved at /etc/secure-ap${NC}"
        fi

        # Reload systemd
        systemctl daemon-reload 2>/dev/null || true

        echo -e "${GREEN}MDVSEC package purged successfully.${NC}"
        ;;

    remove)
        echo -e "${BLUE}MDVSEC: Package removed.${NC}"
        echo -e "${YELLOW}Configuration files preserved at /etc/secure-ap${NC}"
        echo -e "${YELLOW}To completely remove: sudo apt purge mdvsec-ap${NC}"
        ;;

    upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

exit 0
